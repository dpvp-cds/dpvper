<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tus Resultados - DPvPer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'dpvper-app';

        async function init() {
            try {
                // 1. Asegurar sesión
                await signInAnonymously(auth);
                
                // 2. Obtener ID
                const id = sessionStorage.getItem('reportId');
                
                // 3. Validación robusta antes de redirigir
                if (!id || id === "undefined" || id === "") {
                    console.warn("ID de reporte no válido. Redirigiendo al inicio.");
                    window.location.href = 'index.html';
                    return;
                }

                // 4. Escuchar cambios
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reportes_personal', id);
                
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.status === 'completado') {
                            render(data);
                        }
                    } else {
                        console.error("El documento no existe.");
                    }
                }, (error) => {
                    console.error("Error escuchando el documento:", error);
                });

            } catch (err) {
                console.error("Error crítico en inicialización:", err);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Error cargando resultados. Por favor actualice.</p>';
            }
        }

        // Ejecutar con catch para evitar "Unhandled Rejection"
        init().catch(e => console.error("Error global:", e));

        function render(data) {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            
            if(loading) loading.classList.add('hidden');
            if(content) content.classList.remove('hidden');
            
            if(data.demograficos && data.demograficos.nombre) {
                document.getElementById('nombre').innerText = data.demograficos.nombre;
            }
            if(data.arquetipoDominante) {
                document.getElementById('arquetipo').innerText = data.arquetipoDominante;
            }

            if(data.resultados) {
                new Chart(document.getElementById('chart'), {
                    type: 'radar',
                    data: {
                        labels: Object.keys(data.resultados),
                        datasets: [{
                            label: 'Perfil de Propósito',
                            data: Object.values(data.resultados),
                            backgroundColor: 'rgba(232, 166, 19, 0.5)',
                            borderColor: '#E8A613',
                            pointBackgroundColor: '#070404'
                        }]
                    },
                    options: { 
                        responsive: true,
                        scales: { r: { suggestedMin: 0, suggestedMax: 10 } } 
                    }
                });
            }
        }
    </script>
    <style>body { font-family: 'Poppins'; background: #F8F7F2; color: #6B6661; }</style>
</head>
<body>
    <div id="loading" class="h-screen flex items-center justify-center flex-col gap-4">
        <div class="animate-spin h-12 w-12 border-4 border-[#E8A613] rounded-full border-t-transparent"></div>
        <p class="text-[#070404] font-bold animate-pulse">Analizando respuestas...</p>
    </div>
    
    <div id="content" class="hidden container mx-auto px-4 py-12">
        <h1 class="text-3xl font-serif text-[#070404] text-center mb-8">Resultados de <span id="nombre">...</span></h1>
        
        <div class="bg-white p-8 rounded-2xl shadow-lg mb-8 text-center border-t-4 border-[#E8A613]">
            <p class="text-sm uppercase tracking-widest text-gray-500">Tu Impulsor Dominante</p>
            <h2 id="arquetipo" class="text-4xl font-bold text-[#070404] mt-2">...</h2>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg">
            <div class="relative h-80 w-full">
                <canvas id="chart"></canvas>
            </div>
        </div>
        
        <div class="text-center mt-8 flex justify-center gap-4">
            <button onclick="window.print()" class="bg-[#070404] text-white px-6 py-3 rounded-full hover:bg-[#E8A613] transition font-bold">Descargar PDF</button>
            <a href="index.html" class="border-2 border-[#E8A613] text-[#E8A613] px-6 py-3 rounded-full hover:bg-[#E8A613] hover:text-white transition font-bold">Nuevo Test</a>
        </div>
    </div>
</body>
</html>
